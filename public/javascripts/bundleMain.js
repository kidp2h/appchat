(()=>{let e=null,t=null,n=null,a=null;const i=JSON.parse($(".userRecord").val()),s=new Peer({key:"peerjs",host:"peerjs-server-trungquandev.herokuapp.com",secure:!0,port:443,debug:3});let l,r,c="",o=!1,d=io();function m(){$(".contentBoxChat").scrollTop($(".contentBoxChat").prop("scrollHeight"))}$(".lds-hourglass").hide(),$(document).ready((function(){function g(e){$.ajax({type:"POST",url:"/users/updateInfo",data:e,beforeSend:function(){$(".lds-hourglass").show()},success:function(t){t.message?e.gender&&t.message&&swal.fire("Thông báo","Giới tính đã được cập nhật, mật khẩu không thể cập nhật vì mật khẩu hiện tại nhập không đúng","warning"):swal.fire("Thông báo","Cập nhật thành công","success")},complete:function(){$(".lds-hourglass").hide()}})}function u(){o=!1,d.emit("client_typing",{contactId:a.contactId,typing:!1})}async function h(){if(null==a);else{let e=filterXSS($(".textAreaChat").val()).trim(),t={senderId:i._id,usernameSender:i.username,currentUserFriend:a,message:e,time:moment().format("LT"),isTyping:!1};""==e||""!=e&&(function(e){$(".textAreaChat").val(""),d.emit("client_sendMessage",e),i._id==e.senderId?contentBox=`<div class="message me">\n                <di nbcv class="text-main">\n                    <div class="text-group me">\n                        <div class="text me">\n                            <p>${e.message}</p>\n                        </div>\n                    </div>\n                    <span>${e.time}</span>\n                </div>\n            </div>`:contentBox=`<div class="message">\n               <img class="avatar-md" src="${e.currentUserFriend.avatarFriend}"\n                   data-toggle="tooltip" data-placement="top" alt="avatar">\n               <div class="text-main">\n                   <div class="text-group">\n                       <div class="text">\n                          <p>${e.message}</p>\n                       </div>\n                   </div>\n                   <span>${e.time}</span>\n               </div>\n            </div>`,$(".contentChat .allMessage").append(contentBox),m(),$.ajax({type:"POST",url:"/messages/sendMessage",data:e,success:e=>{}})}(t),m())}}function p(){return navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}function v(e){return e.getTracks().forEach((e=>e.stop()))}function f(e,t){const n=document.getElementById(e);n.srcObject=t,n.onloadeddata=function(){n.play()}}function p(){return navigator.mediaDevices.getUserMedia({audio:!1,video:!0})}function f(e,t){const n=document.getElementById(e);n.srcObject=t,n.play()}s.on("open",(function(e){c=e})),$("#chat1 *").prop("disabled",!0),$(".add_friend").click((function(e){$(this).parent().parent().remove();let t=$(this).attr("contactId");$.trim(t),d.emit("client_addFriend",t),$.ajax({type:"POST",url:"/users/addContact",data:{userId:$.trim(i._id),contactId:$.trim(t)},success:function(e){}})})),$(document).on("click",".btn-accept-request",(function(e){$(this).parent().parent().remove();let t=$(this).attr("contactId"),n=$(this).parent().parent().find("img").attr("src"),a=$(this).parent().parent().find("img").attr("data-original-title"),s=$(this).parent().parent().find("img").attr("gender"),l=`<a href="#" class="filterMembers isFriend online contact" data-toggle="list">\n             <img class="avatar-md" src="${n}" data-toggle="tooltip"\n                 data-placement="top" title="${a}" alt="avatar">\n             <div class="data">\n                 <h5>${a}</h5>\n             </div>\n             <div class="person-add">\n                 <i class="material-icons" contactId="${t}">chat</i>\n             </div>\n         </a>`;$(".newRequest").prepend(l);let r=`<a href="#list-chat" contactId="${t}" username="${a}" avatar="${n}" class="filterDiscussions all single chatWithSomeOne"\n             id="list-chat-list" role="tab" >\n             <img class="avatar-md avatarUser" src="${n}" data-toggle="tooltip" data-placement="top" title="${a}" alt="avatar">\n             <div class="data">\n                 <h5 class="usernameFriend">${a}</h5>\n                 <p>Gender : ${s}</p>\n             </div>\n         </a>`;$(".listUserChat").prepend(r);let c={contactId:t,avatarOfContact:n,usernameContact:a,genderContact:s,userId:i._id,currentAvatarUser:i.avatar,username:i.username,gender:i.gender};d.emit("client_acceptRequest",c),$.ajax({type:"POST",url:"/users/acceptRequest",data:{userId:$.trim(i._id),contactId:$.trim(t)},success:function(e){}})})),$(".sendImage").bind("change",(function(e){let t=$(this).prop("files")[0],s={senderId:i._id,currentUserFriend:a,time:moment().format("LT")};if(t.size>1048576&&swal.fire("Thông báo","Ủa có đúng file ảnh không zạ ??. Ảnh dưới 1MB thôi !!","warning"),-1==$.inArray(t.type,["image/jpeg","image/jpg","image/png"])&&swal.fire("Thông báo","Ủa có đúng file ảnh không zạ ??","warning"),null!=typeof FileReader){let e=new FileReader;e.onload=e=>{let t=e.target.result;s.message=t,d.emit("client_sendImage",s);let n=`<div class="message me">\n                    <div class="text-main">\n                        <div class="text-group me">\n                            <div class="text me img_cont_msg">\n                                <img src="${t}" style="width:350px">\n                            </div>\n                        </div>\n                        <span>${s.time}</span>\n                    </div>\n                </div>`;$(".contentChat .allMessage").append(n)},e.readAsDataURL(t);let a=new FormData;a.append("send_image",t),n=a}$.ajax({type:"POST",url:`/messages/sendPicture/${s.senderId}/${s.receiverId}`,cache:!1,contentType:!1,processData:!1,data:n,success:e=>{},complete:e=>{srcImageToSend=null,n=null,formData=null}})})),$(document).on("click",".chatWithSomeOne",(function(e){$("#chat1 *").prop("disabled",!1);let t=$(this).attr("contactId"),n=$(this).attr("username"),s=$(this).attr("avatar");a={usernameFriend:n,contactId:t,avatarFriend:i.avatar},$(".avatarInChat").attr("src",s),$(".avatarInChat").attr("data-original-title",n),$(".avatarInChat").attr("title",n),$(".usernameInChat").text(n),$.ajax({type:"POST",url:`/messages/getConversation/${i._id}/${t}`,data:{avatar:s},beforeSend:function(){$(".lds-hourglass").show()},success:function(e){$(".contentChat .allMessage").html(""),$(".contentChat .allMessage").append(e),m()},complete:function(){$(".lds-hourglass").hide()}})})),$(".textAreaChat").on("keydown",(function(e){13!=e.keyCode||e.shiftKey||e.preventDefault(),"13"!=e.which?(o=!0,d.emit("client_typing",{contactId:a.contactId,isTyping:o}),clearTimeout(l),l=setTimeout(u,1500)):h()})),$(".sendMessage").bind("click",(e=>{clearTimeout(l),h()})),$(".emoji").click((function(e){e.preventDefault();let t=$(this).html();$(".textAreaChat").val($(".textAreaChat").val()+" "+t+" ")})),s.on("open",(function(e){myPeerId=e})),$(document).on("click",".videoCall",(function(e){d.emit("client_checkContactIsOnline",{listener:a,caller:i})})),$(".btn-logout").click((function(e){e.preventDefault(),Swal.fire({title:"Đăng xuất",text:"Bạn có muốn đăng xuất không ?",icon:"question",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Đăng xuất"}).then((e=>{e.value&&$(location).attr("href",window.location.origin+"/users/logout")}))})),$(".input_upload_avatar").bind("change",(function(n){let a=$(this).prop("files")[0];if(a.size>1048576&&swal.fire("Thông báo","Ủa có đúng file ảnh không zạ ??. Ảnh dưới 1MB thôi !!","warning"),-1==$.inArray(a.type,["image/jpeg","image/jpg","image/png"])&&swal.fire("Thông báo","Ủa có đúng file ảnh không zạ ??","warning"),null!=typeof FileReader){let n=new FileReader;n.onload=e=>{$(".image_preview_upload").attr("src",e.target.result),t=e.target.result},n.readAsDataURL(a);let i=new FormData;i.append("avatar",a),e=i}})),$(".apply_uploadAvatar").bind("click",(n=>{n.preventDefault(),e&&$.ajax({type:"POST",url:"/users/uploadAvatar",cache:!1,contentType:!1,processData:!1,data:e,beforeSend:function(){$(".lds-hourglass").show()},success:function(e){$(".avatar-profile").attr("src",t),swal.fire("Thông báo","Cập nhật ảnh đại diện thành công !!","success")},complete:function(){$(".lds-hourglass").hide()}})})),$(".updateInfo").bind("click",(e=>{let t=filterXSS($(".oldPwd").val()),n=filterXSS($(".newPwd").val()),a=filterXSS($(".gender").val());""==t&&""==n&&""==a||(""!=t&&""!=n&&""!=a?t==n?swal.fire("Thông báo","Mật khẩu mới không được trùng mật khẩu hiện tại !!","warning"):"male"!=a&&"female"!=a?swal.fire("Thông báo","Giới tính không hợp lệ !!","warning"):n.length<4?swal.fire("Thông báo","Mật khẩu quá ngắn !!","warning"):""==t||""==n?swal.fire("Thông báo","Để đổi mật khẩu hãy nhập cả mật khẩu hiện tại và mật khẩu mới","warning"):g({currentPwd:t,password:n,gender:a}):""!=a?"male"!=a&&"female"!=a?swal.fire("Thông báo","Giới tính không hợp lệ !!","warning"):g({gender:a}):t==n?swal.fire("Thông báo","Mật khẩu mới không được trùng mật khẩu hiện tại !!","success"):""==t||""==n?swal.fire("Thông báo","Để đổi mật khẩu hãy nhập cả mật khẩu hiện tại và mật khẩu mới","warning"):g({currentPwd:t,password:n}))})),d.on("server_sendMessage",(e=>{a.contactId==e.senderId&&(0==e.isTyping||null==a?($(".typingChat").css("display","none"),m()):($(".typingChat").css("display","block"),m()),null==a||null==a?iziToast.info({position:"bottomRight",title:"Notification",message:`<b>${e.usernameSender}</b> : ${e.message}`}):(i._id==e.senderId?contentBox=`<div class="message me">\n                         <div class="text-main">\n                             <div class="text-group me">\n                                 <div class="text me">\n                                     <p>${e.message}</p>\n                                 </div>\n                             </div>\n                             <span>${e.time}</span>\n                         </div>\n                     </div>`:contentBox=`<div class="message">\n                        <img class="avatar-md" src="${e.currentUserFriend.avatarFriend}"\n                            data-toggle="tooltip" data-placement="top" alt="avatar">\n                        <div class="text-main">\n                            <div class="text-group">\n                                <div class="text">\n                                   <p>${e.message}</p>\n                                </div>\n                            </div>\n                            <span>${e.time}</span>\n                        </div>\n                     </div>`,$(".contentChat .allMessage").append(contentBox),m()))})),d.on("server_sendImage",(e=>{a.contactId==e.senderId&&(null==a||null==a?iziToast.info({position:"bottomRight",title:"Notification",message:`${e.username} : đã gửi một ảnh`}):(i._id==e.senderId?contentBox=`<div class="message me">\n                     <div class="text-main">\n                         <div class="text-group me">\n                             <div class="text me">\n                                 <img src="${e.message}" style="width:350px">\n                             </div>\n                         </div>\n                         <span>${e.time}</span>\n                     </div>\n                 </div>`:contentBox=`<div class="message">\n                    <img class="avatar-md" src="${e.currentUserFriend.avatarFriend}"\n                        data-toggle="tooltip" data-placement="top" alt="avatar">\n                    <div class="text-main">\n                        <div class="text-group">\n                            <div class="text">\n                               <img src="${e.message}" style="width:350px">\n                            </div>\n                        </div>\n                        <span>${e.time}</span>\n                    </div>\n                 </div>`,$(".contentChat .allMessage").append(contentBox),m()))})),d.on("server_typing",(e=>{null==a||null==a||(e.isTyping?($(".typingChat").css("display","block"),m()):($(".typingChat").css("display","none"),m()))})),d.on("server_addFriend",(e=>{let t=`<a href="#" class="filterMembers request_add online contact" data-toggle="list">\n         <img class="avatar-md" src="${e.avatar}" data-toggle="tooltip"\n             data-placement="top" data-original-title="${e.username}" gender="${e.gender}" alt="avatar">\n         <div class="data">\n             <h5>${e.username}</h5>\n         </div>\n         <div class="person-add">\n             <i class="material-icons btn-accept-request"\n                 contactId="${e._id}">check_circle</i>\n         </div>\n     </a>`;iziToast.info({position:"bottomRight",title:"Notification",message:`${e.username} đã gửi lời mời kết bạn đến bạn !!`}),$(".newRequest").prepend(t)})),d.on("server_acceptRequest",(e=>{let t=`<a href="#" class="filterMembers isFriend online contact" data-toggle="list">\n             <img class="avatar-md" src="${e.currentAvatarUser}" data-toggle="tooltip"\n                 data-placement="top" title="${e.username}" alt="avatar">\n             <div class="data">\n                 <h5>${e.username}</h5>\n             </div>\n             <div class="person-add">\n                 <i class="material-icons btn-accept-request" contactId="<%=item._id%>">check_circle</i>\n             </div>\n         </a>`,n=`<a href="#list-chat" contactId="${e.userId}" username="${e.username}" avatar="${e.currentAvatarUser}" class="filterDiscussions all single chatWithSomeOne"\n             id="list-chat-list" role="tab" >\n             <img class="avatar-md avatarUser" src="${e.currentAvatarUser}" data-toggle="tooltip" data-placement="top" title="${e.username}" alt="avatar">\n             <div class="data">\n                 <h5 class="usernameFriend">${e.username}</h5>\n                 <p>Gender : ${e.gender}</p>\n             </div>\n         </a>`;$(".listUserChat").prepend(n),$(".newRequest").prepend(t),iziToast.info({position:"bottomRight",title:"Notification",message:`${e.username} đã chấp nhận lời mời kết bạn !!`})})),d.on("server_contactIsOffline",(()=>{iziToast.info({position:"bottomRight",title:"Notification",message:"Người dùng này hiện tại chưa có mặt, hãy gọi lại sau !"})})),d.on("server_requestPeerId",(e=>{let t={caller:e.caller,listener:e.listener,listenerPeerId:c};d.emit("client_returnPeerId",t)})),d.on("server_returnPeerId",(e=>{d.emit("client_requestCall",e),Swal.fire({title:"Call",html:`Bạn đang gọi cho <b>${e.listener.usernameFriend}</b>\n            <img src="/images/calling.gif" width="40" height="40">\n            <p>\n            <button class="btn btn-caller-cancel-call" style="background-color: rgb(221, 51, 51);height:40px;" name="1"><i class="material-icons md-30">call_end</i></button>\n            </p>\n            `,timer:3e4,showCancelButton:!1,showConfirmButton:!1,timerProgressBar:!0,cancelButtonColor:"#d33",allowOutsideClick:!1,willOpen:()=>{d.emit("client_calling",e),r=setInterval((()=>{}),100)},didOpen:()=>{$(".btn-caller-cancel-call").click((()=>{Swal.close(),d.emit("client_callerCancelCall",e)})),d.on("server_listenerCancelCall",(e=>{Swal.close(),clearInterval(r),Swal.fire("Notification!",`${e.listener.usernameFriend} đã huỷ cuộc gọi !`,"info")}))},willClose:()=>{clearInterval(r)}}).then((t=>{t.dismiss===Swal.DismissReason.timer&&Swal.fire({title:"Notification",text:`${e.listener.usernameFriend} đang bận, hãy thử gọi lại sau`,icon:"info",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Gọi lại ?",allowOutsideClick:!1}).then((e=>{e.isConfirmed&&$(".videoCall").click()}))}))})),d.on("server_callingToListener",(e=>{Swal.fire({title:"Call",html:`${e.caller.username} đang gọi cho bạn\n            <img src="/images/calling.gif" width="40" height="40">\n            <p>\n            <button class="btn btn-listener-cancel-call" style="background-color: rgb(221, 51, 51);height:40px;" name="1"><i class="material-icons md-30">call_end</i></button>\n            <button class="btn btn-listener-accept-call" style="background-color: rgb(48, 133, 214);height:40px;" name="1"><i class="material-icons md-30">call</i></button>\n            </p>\n            `,timer:3e4,showCancelButton:!1,showConfirmButton:!1,timerProgressBar:!0,allowOutsideClick:!1,willOpen:()=>{r=setInterval((()=>{}),100)},didOpen:()=>{$(".btn-listener-cancel-call").click((()=>{Swal.close(),d.emit("client_listenerCancelCall",e)})),$(".btn-listener-accept-call").click((()=>{Swal.close(),d.emit("client_listenerAcceptCall",e)})),d.on("server_callerCancelCall",(e=>{Swal.close(),Swal.fire("Notification!",`${e.caller.username} đã huỷ cuộc gọi !`,"info")}))},willClose:()=>{clearInterval(r)}}).then((e=>{e.dismiss,Swal.DismissReason.timer}))})),d.on("server_listenerAcceptCall_toCaller",(e=>{Swal.close(),clearInterval(r),console.log(e),p().then((t=>{f("userVideo",t),s.call(e.listenerPeerId,t).on("stream",(e=>f("contactVideo",e))),$(".call-end").click((()=>{d.emit("client_callerEndCall",e),v(t),Swal.fire("Call",`Đã kết thúc cuộc gọi với ${e.listener.usernameFriend}`,"info")})),d.on("server_listenerEndCall_toCaller",(e=>{v(t),$("#call1").hide(),$("#chat1").show(),Swal.fire("Call",`${e.listener.usernameFriend} đã kết thúc cuộc gọi !`,"info")}))}),(e=>{Swal.fire("Call","Bạn chưa mở camera hoặc thiết bị của bạn không hỗ trợ","error"),$("#chat1").show(),$("#call1").hide()}))})),d.on("server_listenerAcceptCall_toListener",(e=>{Swal.close(),clearInterval(r),$("#chat1").hide(),$("#call1").show(),s.on("call",(function(t){p().then((n=>{f("userVideo",n),t.answer(n),t.on("stream",(e=>f("contactVideo",e))),$(".call-end").click((()=>{v(n),d.emit("client_listenerEndCall",e),Swal.fire("Call",`Đã kết thúc cuộc gọi với ${e.caller.username}`,"info")})),d.on("server_callerEndCall_toListener",(e=>{v(n),$("#call1").hide(),$("#chat1").show(),Swal.fire("Call",`${e.caller.username} đã kết thúc cuộc gọi !`,"info")}))}),(e=>{Swal.fire("Call","Bạn chưa mở camera hoặc thiết bị của bạn không hỗ trợ","error"),$("#chat1").show(),$("#call1").hide()}))}))}))}))})();